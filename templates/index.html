<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Candlestick Questionnaire</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
  <div class="container">
    <h1>Candlestick Questionnaire</h1>

    <!-- Hidden element to store user_id -->
    <div id="app" data-user-id="{{ user_id }}"></div>

    <!-- Image display -->
    <div class="image-container">
      <img id="candlestick-image" src="" alt="Candlestick" />
    </div>
    
    <!-- Display the predicted value from image click -->
    <p>Selected Value: <span id="selectedValue"></span></p>
    
    <!-- Confidence (1–5) as radio buttons -->
    <p><strong>Confidence (1 = Low, 5 = High):</strong></p>
    <div id="confidenceRadio">
      <label><input type="radio" name="confidence" value="1" required> 1</label>
      <label><input type="radio" name="confidence" value="2"> 2</label>
      <label><input type="radio" name="confidence" value="3" checked> 3</label>
      <label><input type="radio" name="confidence" value="4"> 4</label>
      <label><input type="radio" name="confidence" value="5"> 5</label>
    </div>

    <!-- Visual Clarity (Likert 1–5) as radio buttons -->
    <p><strong>Rate the clarity of the visualization (1 = Unclear, 5 = Very clear):</strong></p>
    <div id="clarityRadio">
      <label><input type="radio" name="visualClarity" value="1" required> 1</label>
      <label><input type="radio" name="visualClarity" value="2"> 2</label>
      <label><input type="radio" name="visualClarity" value="3" checked> 3</label>
      <label><input type="radio" name="visualClarity" value="4"> 4</label>
      <label><input type="radio" name="visualClarity" value="5"> 5</label>
    </div>

    <!-- Submit & Next button -->
    <button id="submitButton">Submit &amp; Next</button>

    <!-- Message shown after last image -->
    <div id="finished-message" class="hidden">
      <h2>Thank you for completing the questionnaire!</h2>
    </div>
  </div>

  <script>
    // The server provides the shuffled list of images.
    const candlestickImages = {{ candlestick_images | tojson }};
    
    // Grab the user_id from our hidden element.
    const user_id = document.getElementById("app").dataset.userId;

    let currentIndex = 0;
    let selectedValue = null;

    // Display the first image on load.
    window.addEventListener("load", showImage);

    function showImage() {
      if (currentIndex >= candlestickImages.length) {
        document.getElementById("candlestick-image").style.display = "none";
        document.getElementById("submitButton").style.display = "none";
        document.getElementById("finished-message").classList.remove("hidden");
        return;
      }
      const imgElement = document.getElementById("candlestick-image");
      imgElement.src = "/static/images/" + candlestickImages[currentIndex];
      selectedValue = null;
      document.getElementById("selectedValue").textContent = "";
    }

    // Click on image to compute a predicted value.
    document.addEventListener("DOMContentLoaded", () => {
      const img = document.getElementById("candlestick-image");
      img.addEventListener("click", event => {
        const rect = img.getBoundingClientRect();
        const offsetY = event.clientY - rect.top;
        const imgHeight = rect.height;

        const minVal = 75;
        const maxVal = 125;
        const valRange = maxVal - minVal;

        // offsetY=0 corresponds to maxVal; offsetY=imgHeight to minVal.
        const ratio = offsetY / imgHeight; 
        let val = maxVal - ratio * valRange;
        val = Math.round(val * 100) / 100;  // round to 2 decimals

        selectedValue = val;
        document.getElementById("selectedValue").textContent = val;
      });
    });

    // Submit & Next: POST selected data to the server, then show next image.
    document.getElementById("submitButton").addEventListener("click", submitAnswer);

    function submitAnswer() {
      if (selectedValue === null) {
        alert("Please click on the image to select a value!");
        return;
      }
      
      // Get selected Confidence value.
      const confidenceRadios = document.getElementsByName('confidence');
      let confidence;
      for (const radio of confidenceRadios) {
        if (radio.checked) {
          confidence = radio.value;
          break;
        }
      }
      
      // Get selected Visual Clarity value.
      const clarityRadios = document.getElementsByName('visualClarity');
      let visualClarity;
      for (const radio of clarityRadios) {
        if (radio.checked) {
          visualClarity = radio.value;
          break;
        }
      }

      const answerData = {
        user_id: user_id,
        image: candlestickImages[currentIndex],
        expectedValue: selectedValue,
        confidence: confidence,
        visualClarity: visualClarity
      };

      // Send POST request to /submit.
      fetch("/submit", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(answerData)
      })
      .then(response => response.json())
      .then(data => {
        console.log("Server response:", data);
        // Move to next image.
        currentIndex++;
        showImage();
      })
      .catch(err => console.error("Error posting data:", err));
    }
  </script>
</body>
</html>
